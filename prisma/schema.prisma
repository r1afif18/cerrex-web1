// CERREX Web Application - Prisma Schema
// Database schema for all 17 Excel sheets

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Project {
  id            String   @id @default(uuid())
  name          String
  reactorType   String?
  country       String?
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  inventoryItems      InventoryItem[]
  isdcCalculations    ISDCCalculation[]
  scheduleItems       ScheduleItem[]
  unitFactors         UnitFactor[]
  
  @@map("projects")
}

// ============================================================================
// LISTS SHEET - Master Data
// ============================================================================

model Currency {
  id                 String  @id @default(uuid())
  code               String  @unique
  name               String
  symbol             String
  exchangeRateToRef  Decimal @db.Decimal(10, 6)
  isReference        Boolean @default(false)
  
  @@map("currencies")
}

model DDCategory {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  category    String  // decontamination, dismantling, demolition, etc.
  
  @@map("dd_categories")
}

model WMCategory {
  id           String  @id @default(uuid())
  iaeaClass    String  // ILW, LLW, VLLW, EW, NonRadioactive
  name         String
  minActivity  Decimal? @db.Decimal(20, 6)
  maxActivity  Decimal? @db.Decimal(20, 6)
  description  String?
  
  @@map("wm_categories")
}

model TechnologicalSystem {
  id          String  @id @default(uuid())
  techId      String  @unique
  name        String
  description String?
  
  @@map("technological_systems")
}

model Profession {
  id           String @id @default(uuid())
  name         String
  abbreviation String @unique
  education    String?
  hourRateOwner      Decimal? @db.Decimal(10, 2)
  hourRateContractor Decimal? @db.Decimal(10, 2)
  
  @@map("professions")
}

// ============================================================================
// UF SHEET - Unit Factors
// ============================================================================

model UnitFactor {
  id           String   @id @default(uuid())
  projectId    String?
  category     String   // DD category or WM category
  type         String   // 'd_and_d' or 'waste_management'
  manpowerUF   Decimal  @db.Decimal(10, 4) // man-hours per unit
  investmentUF Decimal  @db.Decimal(15, 2) // cost per unit
  expensesUF   Decimal  @db.Decimal(15, 2) // cost per unit
  unit         String   // tonne, m2, m3, etc.
  description  String?
  isDefault    Boolean  @default(false)
  
  project      Project? @relation(fields: [projectId], references: [id])
  
  @@map("unit_factors")
}

model WorkDifficultyFactor {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  rangeMin    Decimal @db.Decimal(5, 2)
  rangeMax    Decimal @db.Decimal(5, 2)
  
  @@map("work_difficulty_factors")
}

// ============================================================================
// RND SHEET - Radionuclides
// ============================================================================

model Radionuclide {
  id            String  @id @default(uuid())
  symbol        String  @unique // Ag-108m, Am-241, etc.
  halfLifeYears Decimal @db.Decimal(20, 10)
  rnvColumn     Int?    // Column number in RND sheet
  description   String?
  rnvData       Json?   // Store RNV vectors as JSON
  
  // Relations
  vectors       RadionuclideVector[]
  
  @@map("radionuclides")
}

// ============================================================================
// INV SHEET - Inventory
// ============================================================================

model InventoryItem {
  id                    String   @id @default(uuid())
  projectId             String
  itemNumber            String?  // Sequential number
  description           String
  ddCategory            String   // References DDCategory
  quantity              Decimal  @db.Decimal(15, 4)
  unit                  String   // tonne, m2, m3, etc.
  location              String?
  building              String?
  workDifficultyFactor  Decimal  @default(1.0) @db.Decimal(5, 2)
  
  // Waste partitioning (percentages that sum to 1.0)
  wastePartitionILW     Decimal  @default(0) @db.Decimal(5, 4)
  wastePartitionLLW     Decimal  @default(0) @db.Decimal(5, 4)
  wastePartitionVLLW    Decimal  @default(0) @db.Decimal(5, 4)
  wastePartitionEW      Decimal  @default(0) @db.Decimal(5, 4)
  wastePartitionNonRad  Decimal  @default(0) @db.Decimal(5, 4)
  
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  project               Project  @relation(fields: [projectId], references: [id])
  radionuclideVectors   RadionuclideVector[]
  
  @@map("inventory_items")
}

// ============================================================================
// ADIN SHEET - Advanced Inventory Database (Radionuclide Vectors)
// ============================================================================

model RadionuclideVector {
  id            String   @id @default(uuid())
  itemId        String
  nuclideId     String
  fraction      Decimal  @db.Decimal(10, 8) // Fraction of total activity
  referenceDate DateTime
  activityLevel Decimal  @db.Decimal(20, 6) // Bq or other unit
  
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  nuclide       Radionuclide  @relation(fields: [nuclideId], references: [id])
  
  @@map("radionuclide_vectors")
}

// ============================================================================
// ISDC SHEET - ISDC Structure & Calculations
// ============================================================================

model ISDCStructure {
  code         String  @id // '01', '01.0100', '01.0101', etc.
  level        Int     // 1, 2, or 3
  parentCode   String?
  description  String
  isActive     Boolean @default(true)
  
  // Activity type flags
  isInventoryDependent Boolean @default(false)
  isPeriodDependent    Boolean @default(false)
  isWasteManagement    Boolean @default(false)
  
  @@map("isdc_structure")
}

model ISDCCalculation {
  id                  String   @id @default(uuid())
  projectId           String
  isdcCode            String   // References ISDCStructure
  
  // Input quantities
  quantity            Decimal? @db.Decimal(15, 4)
  duration            Int?     // days for period-dependent
  
  // Calculated manpower
  manpowerHours       Decimal  @default(0) @db.Decimal(12, 2)
  
  // ISDC Cost Categories
  labourCost          Decimal  @default(0) @db.Decimal(15, 2)
  investmentCost      Decimal  @default(0) @db.Decimal(15, 2)
  expenses            Decimal  @default(0) @db.Decimal(15, 2)
  
  // Contingency
  contingencyPercent  Decimal  @default(0) @db.Decimal(5, 2)
  contingencyAmount   Decimal  @default(0) @db.Decimal(15, 2)
  
  // Total
  totalCost           Decimal  @default(0) @db.Decimal(15, 2)
  
  // Period-dependent data (JSON for flexibility)
  periodData          Json?    // {staff: {...}, costFactors: {...}}
  
  // Collateral costs
  collateralCosts     Json?    // One-off costs as JSON
  
  calculatedAt        DateTime @default(now())
  updatedAt           DateTime @updatedAt
  notes               String?
  
  project             Project  @relation(fields: [projectId], references: [id])
  
  @@map("isdc_calculations")
}

// ============================================================================
// SCHDL SHEET - Scheduling
// ============================================================================

model ScheduleItem {
  id             String   @id @default(uuid())
  projectId      String
  isdcCode       String   // Link to ISDC item
  sequenceOrder  Int
  durationDays   Int
  startDate      DateTime?
  endDate        DateTime?
  dependencies   Json?    // Array of dependent ISDC codes
  notes          String?
  
  project        Project  @relation(fields: [projectId], references: [id])
  
  @@map("schedule_items")
}

// ============================================================================
// CSHFL SHEET - Cash Flow (Derived from Schedule + Costs)
// This is a view/computed data, not stored directly
// ============================================================================

// ============================================================================
// BLD SHEET - Buildings (Extension of Inventory)
// ============================================================================

model Building {
  id           String  @id @default(uuid())
  name         String
  code         String  @unique
  description  String?
  area         Decimal? @db.Decimal(12, 2) // m2
  volume       Decimal? @db.Decimal(12, 2) // m3
  type         String? // Reactor building, control building, etc.
  
  @@map("buildings")
}

// ============================================================================
// SMHW SHEET - Technological Systems (Simple list)
// Already covered by TechnologicalSystem model above
// ============================================================================

// ============================================================================
// INV SA - Sensitivity Analysis Data
// ============================================================================

model SensitivityAnalysis {
  id               String   @id @default(uuid())
  projectId        String
  name             String
  parameterName    String   // What's being varied
  baseValue        Decimal  @db.Decimal(20, 6)
  variationFactors Json     // [0.01, 0.1, 1, 10, 100]
  results          Json     // Calculated results
  createdAt        DateTime @default(now())
  
  @@map("sensitivity_analyses")
}

// ============================================================================
// CTGR, L0, ISDCL1/L2/L3 - These are presentation/reporting sheets
// Data comes from aggregating ISDCCalculation and other tables
// No separate models needed - handled by queries/views
// ============================================================================

// ============================================================================
// GENERAL SHEET - Project summary data
// Computed from other tables, stored in Project model metadata or computed on-the-fly
// ============================================================================

// Additional utility models

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String   // create, update, delete, calculate
  tableName   String
  recordId    String?
  changes     Json?
  timestamp   DateTime @default(now())
  
  @@map("audit_logs")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String?
  passwordHash  String
  createdAt     DateTime @default(now())
  lastLoginAt   DateTime?
  
  @@map("users")
}
